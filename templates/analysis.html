<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Analytics - InfluencerAI</title>
    <meta name="description" content="Comprehensive campaign analytics and AI-powered insights for your influencer marketing campaigns.">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">
                <img src="{{ url_for('static', filename='images/main_logo.png') }}" alt="Insyte Logo" width="30%">
            </a>
            <ul class="nav-links">
                <li><a href="/results">Find Influencers</a></li>
                <li><a href="/campaign">Campaign Management</a></li>
                <li><a class="active" href="/analysis">Campaign Analysis</a></li>
                <li><a href="/super-manager" class="super-manager-link">Super Manager</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Page Header -->
        <section class="page-header fade-in-up">
            <h1>Campaign Analytics & Insights</h1>
            <p>AI-powered analysis of your campaign performance with actionable recommendations.</p>
        </section>

        <!-- Analysis Form -->
        <section class="card analysis-form fade-in-up">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-search"></i> Campaign Analysis
                </h2>
            </div>
            <form id="analysisForm" class="analysis-form-content">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="campaignName">Campaign Name</label>
                        <select class="form-select" id="campaignName" name="campaign_name" required>
                            <option value="">Select a campaign...</option>
                    </select>
                </div>
                    <div class="form-group">
                        <label class="form-label" for="analysisType">Analysis Type</label>
                        <select class="form-select" id="analysisType" name="analysis_type" required>
                            <option value="">Select analysis type...</option>
                            <option value="campaign_performance">Campaign Performance</option>
                            <option value="influencer_performance">Influencer Performance</option>
                            <option value="audience_insights">Audience Insights</option>
                    </select>
                </div>
            </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-large">
                        <i class="fas fa-chart-line"></i> Analyze Campaign
                </button>
            </div>
            </form>
        </section>

        <!-- Analysis Results -->
        <section id="analysisResults" class="card analysis-results fade-in-up" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-chart-bar"></i> Analysis Results
                </h2>
                <div class="table-actions">
                    <button id="summaryBtn" class="btn btn-secondary" type="button">
                        <i class="fas fa-wand-magic-sparkles"></i> Generate AI Summary
                    </button>
                </div>
                <div id="analysisSummary" class="card" style="display:none; margin: 1rem; padding: 1rem;"></div>
            </div>
            <div id="analysisContent"></div>
            
        </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>insyte</h4>
                <p>Influencer outreach & CRM agent</p>
                <p>Powered by QRaptor</p>
            </div>
            <div class="footer-section">
                <h4>Platform</h4>
                <ul>
                    <li><a href="/results">Find Influencers</a></li>
                    <li><a href="/campaign">Campaign Management</a></li>
                    <li><a href="/analysis">Campaign Analysis</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Resources</h4>
                <ul>
                    <li><a href="/#how-it-works">How It Works</a></li>
                    <li><a href="/#demo">Demo</a></li>
                    <li><a href="/#pricing">Pricing</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Connect</h4>
                <div class="social-links">
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                    <a href="#"><i class="fab fa-github"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 insyte. Built for A2HackFest. Powered by QRaptor.</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Analysis page specific JavaScript
        let charts = {};
        let currentCampaignData = null;
        
        // Loading functions (in case main.js functions are not available)
        function showLoading(message = 'Loading...') {
            // Reuse existing overlay if present
            let loadingDiv = document.getElementById('loadingOverlay');
            if (!loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingOverlay';
            }
            loadingDiv.innerHTML = `
                <div class="loading-overlay">
                    <div class="loading-content">
                        <div class="loading"></div>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            loadingDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(15, 23, 42, 0.35);
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            // Auto-timeout cleanup to avoid stuck overlay in edge cases
            loadingDiv.setAttribute('data-created-at', String(Date.now()));
            setTimeout(() => {
                const el = document.getElementById('loadingOverlay');
                if (el) {
                    el.remove();
                }
            }, 60000);

            if (!document.body.contains(loadingDiv)) {
                document.body.appendChild(loadingDiv);
            }
        }

        function hideLoading() {
            const overlays = document.querySelectorAll('#loadingOverlay');
            overlays.forEach(el => el.remove());
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#8b5cf6'};
                color: white;
                border-radius: 8px;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function showError(message) {
            showNotification(message, 'error');
        }
        
        // Sample data for demonstration
        const sampleData = {
            campaign1: {
                name: "Summer Product Launch 2024",
                totalInfluencers: 25,
                totalReach: 2500000,
                totalEngagement: 125000,
                avgBrandFit: 87,
                emailsSent: 25,
                responseRate: 68,
                performance: [
                    { date: '2024-01-01', engagement: 1200, reach: 50000 },
                    { date: '2024-01-08', engagement: 1800, reach: 75000 },
                    { date: '2024-01-15', engagement: 2200, reach: 95000 },
                    { date: '2024-01-22', engagement: 2800, reach: 120000 },
                    { date: '2024-01-29', engagement: 3200, reach: 150000 }
                ],
                influencers: [
                    { name: 'Sarah Johnson', platform: 'Instagram', followers: 125000, engagement: 4.8, brandFit: 92, contentQuality: 'A', responseStatus: 'Responded', performanceGrade: 'A+' },
                    { name: 'Mike Chen', platform: 'YouTube', followers: 450000, engagement: 6.2, brandFit: 88, contentQuality: 'A', responseStatus: 'Responded', performanceGrade: 'A' },
                    { name: 'Emma Rodriguez', platform: 'TikTok', followers: 890000, engagement: 8.5, brandFit: 85, contentQuality: 'B+', responseStatus: 'Pending', performanceGrade: 'B+' }
                ]
            }
        };
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadSampleData();
        });
        
        function initializeCharts() {
            // Engagement Chart
            const engagementCtx = document.getElementById('engagementChart').getContext('2d');
            charts.engagement = new Chart(engagementCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Engagement',
                        data: [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a1a1aa'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a1a1aa'
                            }
                        }
                    }
                }
            });
            
            // Reach Chart
            const reachCtx = document.getElementById('reachChart').getContext('2d');
            charts.reach = new Chart(reachCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Reach',
                        data: [],
                        backgroundColor: '#a855f7',
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a1a1aa'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a1a1aa'
                            }
                        }
                    }
                }
            });
            
            // Brand Fit Chart
            const brandFitCtx = document.getElementById('brandFitChart').getContext('2d');
            charts.brandFit = new Chart(brandFitCtx, {
                type: 'doughnut',
                data: {
                    labels: ['90-100%', '80-89%', '70-79%', '60-69%'],
                    datasets: [{
                        data: [8, 12, 3, 2],
                        backgroundColor: ['#10b981', '#8b5cf6', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#a1a1aa'
                            }
                        }
                    }
                }
            });
            
            // Platform Chart
            const platformCtx = document.getElementById('platformChart').getContext('2d');
            charts.platform = new Chart(platformCtx, {
                type: 'pie',
                data: {
                    labels: ['Instagram', 'YouTube', 'TikTok', 'LinkedIn', 'Twitter'],
                    datasets: [{
                        data: [12, 8, 3, 1, 1],
                        backgroundColor: ['#e4405f', '#ff0000', '#000000', '#0077b5', '#1da1f2']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#a1a1aa'
                            }
                        }
                    }
                }
            });
        }
        
        function loadSampleData() {
            currentCampaignData = sampleData.campaign1;
            updateOverview();
            updateCharts();
            updateInsights();
            updatePerformanceTable();
            updatePredictions();
            updateActionItems();
        }
        
        function updateOverview() {
            if (!currentCampaignData) return;
            
            document.getElementById('totalInfluencers').textContent = currentCampaignData.totalInfluencers;
            document.getElementById('totalReach').textContent = formatNumber(currentCampaignData.totalReach);
            document.getElementById('totalEngagement').textContent = formatNumber(currentCampaignData.totalEngagement);
            document.getElementById('avgBrandFit').textContent = currentCampaignData.avgBrandFit + '%';
            document.getElementById('emailsSent').textContent = currentCampaignData.emailsSent;
            document.getElementById('responseRate').textContent = currentCampaignData.responseRate + '%';
        }
        
        function updateCharts() {
            if (!currentCampaignData) return;
            
            const performance = currentCampaignData.performance;
            const labels = performance.map(p => new Date(p.date).toLocaleDateString());
            const engagementData = performance.map(p => p.engagement);
            const reachData = performance.map(p => p.reach);
            
            // Update engagement chart
            charts.engagement.data.labels = labels;
            charts.engagement.data.datasets[0].data = engagementData;
            charts.engagement.update();
            
            // Update reach chart
            charts.reach.data.labels = labels;
            charts.reach.data.datasets[0].data = reachData;
            charts.reach.update();
        }
        
        function updateInsights() {
            if (!currentCampaignData) return;
            
            // Top performers
            const topPerformers = currentCampaignData.influencers
                .sort((a, b) => b.brandFit - a.brandFit)
                .slice(0, 3);
            
            document.getElementById('topPerformers').innerHTML = topPerformers.map(inf => 
                `<div class="performer-item">
                    <strong>${inf.name}</strong> - ${inf.brandFit}% brand fit
                </div>`
            ).join('');
            
            // Improvement areas
            document.getElementById('improvementAreas').innerHTML = `
                <div class="improvement-item">
                    <i class="fas fa-arrow-down"></i>
                    Response rate could improve with better email personalization
                </div>
                <div class="improvement-item">
                    <i class="fas fa-arrow-down"></i>
                    Consider targeting more micro-influencers for higher engagement
                </div>
            `;
            
            // Optimization recommendations
            document.getElementById('optimizationRecs').innerHTML = `
                <div class="rec-item">
                    <i class="fas fa-check"></i>
                    Focus on Instagram and YouTube for best results
                </div>
                <div class="rec-item">
                    <i class="fas fa-check"></i>
                    Increase outreach to influencers with 80%+ brand fit
                </div>
            `;
            
            // ROI analysis
            document.getElementById('roiAnalysis').innerHTML = `
                <div class="roi-metric">
                    <strong>Cost per engagement:</strong> $0.15
                </div>
                <div class="roi-metric">
                    <strong>ROI:</strong> 320%
                </div>
            `;
        }
        
        function updatePerformanceTable() {
            if (!currentCampaignData) return;
            
            const tbody = document.getElementById('performanceTableBody');
            tbody.innerHTML = currentCampaignData.influencers.map(inf => `
                <tr>
                    <td>
                        <div class="influencer-info">
                            <img src="https://via.placeholder.com/40x40/8b5cf6/ffffff?text=${inf.name.split(' ').map(n => n[0]).join('')}" 
                                 alt="${inf.name}" class="influencer-avatar-small">
                            <div>
                                <div class="influencer-name">${inf.name}</div>
                                <div class="influencer-username">@${inf.name.toLowerCase().replace(' ', '_')}</div>
                            </div>
                        </div>
                    </td>
                    <td>${inf.platform}</td>
                    <td>${formatNumber(inf.followers)}</td>
                    <td>${inf.engagement}%</td>
                    <td>
                        <div class="brand-fit-badge brand-fit-${Math.floor(inf.brandFit / 10)}">
                            ${inf.brandFit}%
                        </div>
                    </td>
                    <td>
                        <div class="quality-badge quality-${inf.contentQuality}">
                            ${inf.contentQuality}
                        </div>
                    </td>
                    <td>
                        <div class="status-badge status-${inf.responseStatus.toLowerCase()}">
                            ${inf.responseStatus}
                        </div>
                    </td>
                    <td>
                        <div class="grade-badge grade-${inf.performanceGrade}">
                            ${inf.performanceGrade}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function updatePredictions() {
            // Update 30-day predictions
            document.getElementById('predictedReach30').textContent = formatNumber(3000000);
            document.getElementById('predictedEngagement30').textContent = formatNumber(180000);
            document.getElementById('successProb30').textContent = '85%';
            
            // Update 90-day predictions
            document.getElementById('predictedReach90').textContent = formatNumber(8000000);
            document.getElementById('predictedEngagement90').textContent = formatNumber(450000);
            document.getElementById('successProb90').textContent = '92%';
            
            // Update trend analysis
            document.getElementById('currentTrend').textContent = '↗️ Growing';
            document.getElementById('currentTrend').className = 'trend-value positive';
            document.getElementById('peakSeason').textContent = 'Q4 2024';
            document.getElementById('optimizationWindow').textContent = '2 weeks';
        }
        
        function updateActionItems() {
            const actionItems = [
                {
                    priority: 'high',
                    title: 'Optimize Email Templates',
                    description: 'Personalize outreach emails based on influencer content style and audience demographics',
                    deadline: 'Within 1 week',
                    impact: 'High'
                },
                {
                    priority: 'medium',
                    title: 'Expand Platform Reach',
                    description: 'Consider adding TikTok and LinkedIn to diversify influencer portfolio',
                    deadline: 'Within 2 weeks',
                    impact: 'Medium'
                },
                {
                    priority: 'low',
                    title: 'Review Brand Fit Threshold',
                    description: 'Lower minimum brand fit score to 75% to increase candidate pool',
                    deadline: 'Within 1 month',
                    impact: 'Low'
                }
            ];
            
            document.getElementById('actionItems').innerHTML = actionItems.map(item => `
                <div class="action-item priority-${item.priority}">
                    <div class="action-header">
                        <div class="action-priority">
                            <span class="priority-badge priority-${item.priority}">${item.priority.toUpperCase()}</span>
                        </div>
                        <div class="action-title">${item.title}</div>
                        <div class="action-impact">Impact: ${item.impact}</div>
                    </div>
                    <div class="action-description">${item.description}</div>
                    <div class="action-footer">
                        <span class="action-deadline">Deadline: ${item.deadline}</span>
                        <button class="btn btn-secondary btn-small" onclick="markComplete(this)">
                            Mark Complete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function refreshInsights() {
            showNotification('Refreshing AI insights...', 'info');
            setTimeout(() => {
                updateInsights();
                showNotification('Insights refreshed successfully!', 'success');
            }, 2000);
        }
        
        function exportData() {
            showNotification('Exporting campaign data...', 'info');
            setTimeout(() => {
                showNotification('Data exported successfully!', 'success');
            }, 1500);
        }
        
        function generateReport() {
            showNotification('Generating comprehensive report...', 'info');
            setTimeout(() => {
                showNotification('Report generated successfully!', 'success');
            }, 2000);
        }
        
        function compareCampaigns() {
            const campaign1 = document.getElementById('campaign1').value;
            const campaign2 = document.getElementById('campaign2').value;
            
            if (!campaign1 || !campaign2) {
                showNotification('Please select two campaigns to compare', 'error');
                return;
            }
            
            showNotification('Generating comparison chart...', 'info');
            // Here you would implement the actual comparison logic
        }
        
        function markComplete(button) {
            const actionItem = button.closest('.action-item');
            actionItem.style.opacity = '0.5';
            button.textContent = 'Completed';
            button.disabled = true;
            showNotification('Action item marked as complete!', 'success');
        }
        
        function loadCampaignData() {
            const campaignId = document.getElementById('campaignSelect').value;
            if (campaignId && sampleData[campaignId]) {
                currentCampaignData = sampleData[campaignId];
                updateOverview();
                updateCharts();
                updateInsights();
                updatePerformanceTable();
                updatePredictions();
                updateActionItems();
                showNotification(`Loaded campaign: ${currentCampaignData.name}`, 'success');
            }
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Analysis Form Handling
        let campaignIdMap = {}; // Store campaign name to ID mapping
        let lastAnalysisContext = { campaignId: null, analysisType: null };
        
        document.addEventListener('DOMContentLoaded', function() {
            loadCampaignsForAnalysis();
            
            // Add form submit handler
            document.getElementById('analysisForm').addEventListener('submit', handleAnalysisSubmit);
            
            // Wire summary button
            const summaryBtn = document.getElementById('summaryBtn');
            if (summaryBtn) {
                summaryBtn.addEventListener('click', handleGenerateSummary);
            }
        });

        async function handleGenerateSummary() {
            try {
                const campaignId = lastAnalysisContext.campaignId;
                const analysisType = lastAnalysisContext.analysisType;
                if (!campaignId || !analysisType) {
                    showError('Run an analysis first');
                    return;
                }
                showLoading('Generating AI summary...');
                const resp = await fetch('/api/analysis_summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ campaign_id: campaignId, analysis_type: analysisType })
                });
                const data = await resp.json();
                if (!data.success) {
                    showError(data.message || 'Failed to generate summary');
                    return;
                }
                const sumDiv = document.getElementById('analysisSummary');
                sumDiv.style.display = 'block';
                sumDiv.innerHTML = renderSummaryBlock(data.summary, analysisType);
                showNotification('Summary generated', 'success');
            } catch (e) {
                console.error('Summary error:', e);
                showError('Failed to generate summary');
            } finally {
                hideLoading();
            }
        }

        function renderSummaryBlock(summary, analysisType) {
            if (typeof summary === 'string') {
                return `<h3 style="margin-bottom:0.5rem">AI Summary</h3><p>${summary}</p>`;
            }
            try {
                const pretty = JSON.stringify(summary, null, 2);
                return `<h3 style="margin-bottom:0.5rem">AI Summary</h3><pre class="code-block">${pretty}</pre>`;
            } catch {
                return `<h3 style="margin-bottom:0.5rem">AI Summary</h3><pre class="code-block">${summary}</pre>`;
            }
        }

        async function handleAnalysisSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const campaignName = formData.get('campaign_name');
            const analysisType = formData.get('analysis_type');
            
            // Get campaign ID from the mapping
            const campaignId = campaignIdMap[campaignName];
            
            if (!campaignId) {
                showError('Please select a valid campaign');
                return;
            }
            
            const payload = {
                campaign_id: campaignId,
                analysis_type: analysisType
            };

            try {
                showLoading('Analyzing campaign data...');
                console.log('Payload:', payload);
                
                const response = await fetch('/api/analyze_campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.success) {
                    // Store context for summary
                    lastAnalysisContext = { campaignId, analysisType };
                    
                    displayAnalysisResults(result.analysis, analysisType);
                    showNotification('Analysis completed successfully!', 'success');
                } else {
                    showError(result.message || 'Analysis failed');
                }
            } catch (error) {
                console.error('Error analyzing campaign:', error);
                showError('An error occurred while analyzing the campaign');
            } finally {
                hideLoading();
            }
        }

        function displayAnalysisResults(analysis, analysisType) {
            const resultsSection = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('analysisContent');
            
            if (!resultsSection || !contentDiv) {
                console.error('Required DOM elements not found:', { resultsSection, contentDiv });
                showError('Display elements not found. Please refresh the page.');
                return;
            }
            
            // Reset summary on new analysis
            const sumDiv = document.getElementById('analysisSummary');
            if (sumDiv) { sumDiv.style.display = 'none'; sumDiv.innerHTML = ''; }
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            console.log('Displaying analysis results:', { analysis, analysisType });

            if (analysisType === 'campaign_performance') {
                displayCampaignPerformance(analysis);
            } else if (analysisType === 'influencer_performance') {
                displayInfluencerPerformance(analysis);
            } else if (analysisType === 'audience_insights') {
                displayAudienceInsights(analysis);
            } else {
                console.error('Unknown analysis type:', analysisType);
                showError('Unknown analysis type');
            }
        }

        async function resolveInfluencerNames(res) {
            try {
                const ids = Array.from(new Set(res.map(r => r.influencer_id).filter(Boolean)));
                if (!ids.length) return {};
                const resp = await fetch('/api/influencer_lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });
                const data = await resp.json();
                if (data.success) return data.map || {};
                return {};
            } catch (e) {
                console.warn('Name resolution failed:', e);
                return {};
            }
        }

        async function displayInfluencerPerformance(analysis) {
            const contentDiv = document.getElementById('analysisContent');
            const res = analysis.outputs?.res || [];
            
            if (!res || res.length === 0) {
                contentDiv.innerHTML = '<p class="text-center">No influencer performance data available.</p>';
                return;
            }

            // Resolve names
            const idMap = await resolveInfluencerNames(res);

            // Calculate totals and averages
            const totals = res.reduce((acc, item) => {
                acc.impressions += parseInt(item.impressions) || 0;
                acc.reach += parseInt(item.reach) || 0;
                acc.engagements += parseInt(item.engagements) || 0;
                acc.clicks += parseInt(item.clicks) || 0;
                acc.conversions += parseInt(item.conversions) || 0;
                acc.spend += parseFloat(item.spend) || 0;
                acc.engagement_rate += parseFloat(item.engagement_rate) || 0;
                return acc;
            }, { impressions: 0, reach: 0, engagements: 0, clicks: 0, conversions: 0, spend: 0, engagement_rate: 0 });

            const avgEngagementRate = totals.engagement_rate / res.length;
            const avgCpc = totals.clicks > 0 ? totals.spend / totals.clicks : 0;
            const avgCpa = totals.conversions > 0 ? totals.spend / totals.conversions : 0;
            const avgRoi = totals.spend > 0 ? (totals.conversions * 25) / totals.spend : 0;

            contentDiv.innerHTML = `
                <!-- Influencer Performance Overview -->
                <div class="performance-overview">
                    <h3>Influencer Performance Overview</h3>
                    <div class="metrics-grid compact metric-group">
                        ${metricCard('Average Engagement Rate', `${avgEngagementRate.toFixed(2)}%`, 'fa-percent', true)}
                        ${metricCard('Average CPC', `$${avgCpc.toFixed(2)}`, 'fa-mouse-pointer', true)}
                        ${metricCard('Average CPA', `$${avgCpa.toFixed(2)}`, 'fa-user-check', true)}
                        ${metricCard('ROI', `${avgRoi.toFixed(2)}x`, 'fa-chart-line', true)}
                    </div>
                </div>

                <!-- Summary KPIs -->
                <div class="performance-metrics">
                    <h3>Totals</h3>
                    <div class="metrics-grid compact metric-group">
                        ${metricCard('Total Impressions', formatNumber(totals.impressions), 'fa-eye', true)}
                        ${metricCard('Total Reach', formatNumber(totals.reach), 'fa-users', true)}
                        ${metricCard('Total Engagements', formatNumber(totals.engagements), 'fa-heart', true)}
                        ${metricCard('Total Clicks', formatNumber(totals.clicks), 'fa-mouse-pointer', true)}
                        ${metricCard('Total Conversions', formatNumber(totals.conversions), 'fa-chart-line', true)}
                        ${metricCard('Total Spend', `$${totals.spend.toFixed(2)}`, 'fa-dollar-sign', true)}
                    </div>
                </div>

                <!-- Influencer Performance Charts -->
                <div class="performance-charts">
                    <h3>Influencer Performance Analysis</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>Engagement Rate by Influencer</h4>
                            <canvas id="influencerEngagementChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Reach vs Impressions</h4>
                            <canvas id="influencerReachImpressionsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Cost Efficiency (CPC vs CPA)</h4>
                            <canvas id="influencerCostChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Performance Distribution</h4>
                            <canvas id="influencerPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Performers -->
                <div class="top-performers">
                    <h3>Top Performing Influencers</h3>
                    <div class="performers-grid">
                        ${res
                            .sort((a, b) => parseFloat(b.engagement_rate) - parseFloat(a.engagement_rate))
                            .slice(0, 3)
                            .map((influencer, index) => `
                                <div class="performer-card">
                                    <div class="performer-rank">#${index + 1}</div>
                                    <div class="performer-info">
                                        <h4>${idMap[String(influencer.influencer_id)] || `Influencer ${influencer.influencer_id}`}</h4>
                                        <div class="performer-stats">
                                            <div class="stat">
                                                <span class="stat-label">Engagement Rate:</span>
                                                <span class="stat-value">${parseFloat(influencer.engagement_rate).toFixed(2)}%</span>
                                            </div>
                                            <div class="stat">
                                                <span class="stat-label">Reach:</span>
                                                <span class="stat-value">${formatNumber(parseInt(influencer.reach))}</span>
                                            </div>
                                            <div class="stat">
                                                <span class="stat-label">Conversions:</span>
                                                <span class="stat-value">${formatNumber(parseInt(influencer.conversions))}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                    </div>
                </div>

                <!-- Detailed Influencer Table -->
                <div class="performance-table">
                    <h3>Detailed Influencer Performance</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Influencer</th>
                                    <th>Impressions</th>
                                    <th>Reach</th>
                                    <th>Engagements</th>
                                    <th>Clicks</th>
                                    <th>Conversions</th>
                                    <th>Engagement Rate</th>
                                    <th>Spend</th>
                                    <th>CPC</th>
                                    <th>CPA</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${res.map(item => {
                                    const cpc = parseFloat(item.spend) / parseInt(item.clicks);
                                    const cpa = parseFloat(item.spend) / parseInt(item.conversions);
                                    const name = idMap[String(item.influencer_id)] || `Influencer ${item.influencer_id}`;
                                    const username = (name || '').toLowerCase().replace(/\s+/g,'_');
                                    return `
                                        <tr>
                                            <td>${name}</td>
                                            <td>${formatNumber(parseInt(item.impressions))}</td>
                                            <td>${formatNumber(parseInt(item.reach))}</td>
                                            <td>${formatNumber(parseInt(item.engagements))}</td>
                                            <td>${formatNumber(parseInt(item.clicks))}</td>
                                            <td>${formatNumber(parseInt(item.conversions))}</td>
                                            <td>${parseFloat(item.engagement_rate).toFixed(2)}%</td>
                                            <td>$${parseFloat(item.spend).toFixed(2)}</td>
                                            <td>$${cpc.toFixed(2)}</td>
                                            <td>$${cpa.toFixed(2)}</td>
                                            <td>${new Date(item.report_date).toLocaleDateString()}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" onclick="openEmailModal('${name.replace(/'/g, "&#39;")}', '${username}')">
                                                    <i class="fas fa-envelope"></i> Email
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Email Modal -->
                <div id="emailModal" class="email-modal">
                    <div class="email-modal-content">
                        <div class="email-modal-header">
                            <div class="email-modal-title">Send Email</div>
                            <button class="email-modal-close" onclick="closeEmailModal()">&times;</button>
                        </div>
                        <div class="email-modal-body">
                            <div class="email-form-group">
                                <label class="email-form-label" for="email_to">To</label>
                                <input id="email_to" class="email-form-input" placeholder="recipient@example.com" />
                            </div>
                            <div class="email-form-group">
                                <label class="email-form-label" for="email_subject">Subject</label>
                                <input id="email_subject" class="email-form-input" placeholder="Subject" />
                            </div>
                            <div class="email-form-group">
                                <label class="email-form-label" for="email_body">Body</label>
                                <textarea id="email_body" class="email-form-input email-form-textarea" placeholder="Email body..."></textarea>
                            </div>
                            <div class="email-preview">
                                <div class="email-preview-header">Preview</div>
                                <div id="email_preview" class="email-preview-content"></div>
                            </div>
                        </div>
                        <div class="email-form-actions">
                            <button class="email-btn email-btn-secondary" onclick="closeEmailModal()">Cancel</button>
                            <button id="emailSendBtn" class="email-btn email-btn-primary" onclick="sendEmailSimple()">
                                <span class="email-loading" style="display:none"></span>Send Email
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Create charts after DOM is updated
            setTimeout(() => {
                createInfluencerPerformanceCharts(res, idMap);
            }, 100);
        }

        function metricCard(label, value, icon, compact) {
            const cls = compact ? 'metric-card compact' : 'metric-card';
            return `
                <div class="${cls}">
                    <div class="overview-icon">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="overview-content">
                        <div class="metric-value">${value}</div>
                        <div class="metric-label">${label}</div>
                    </div>
                </div>
            `;
        }

        function createInfluencerPerformanceCharts(data, idMap) {
            const labels = data.map(item => idMap[String(item.influencer_id)] || `Influencer ${item.influencer_id}`);
            const engagementRates = data.map(item => parseFloat(item.engagement_rate));
            const reach = data.map(item => parseInt(item.reach));
            const impressions = data.map(item => parseInt(item.impressions));
            const clicks = data.map(item => parseInt(item.clicks));
            const conversions = data.map(item => parseInt(item.conversions));
            const spend = data.map(item => parseFloat(item.spend));

            // Engagement Rate Chart
            const engagementCtx = document.getElementById('influencerEngagementChart');
            if (engagementCtx) {
                new Chart(engagementCtx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Engagement Rate (%)',
                            data: engagementRates,
                            backgroundColor: '#8b5cf6',
                            borderColor: '#7c3aed',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } },
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } }
                        }
                    }
                });
            }

            // Reach vs Impressions Chart
            const reachImpressionsCtx = document.getElementById('influencerReachImpressionsChart');
            if (reachImpressionsCtx) {
                new Chart(reachImpressionsCtx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Reach', data: reach, backgroundColor: '#10b981', borderColor: '#059669', borderWidth: 1 },
                            { label: 'Impressions', data: impressions, backgroundColor: '#3b82f6', borderColor: '#2563eb', borderWidth: 1 }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top', labels: { color: '#a1a1aa' } } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } },
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } }
                        }
                    }
                });
            }

            // Cost Efficiency Chart
            const costCtx = document.getElementById('influencerCostChart');
            if (costCtx) {
                const cpc = data.map(item => parseFloat(item.spend) / parseInt(item.clicks));
                const cpa = data.map(item => parseFloat(item.spend) / parseInt(item.conversions));
                
                new Chart(costCtx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Cost Per Click', data: cpc, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', tension: 0.4 },
                            { label: 'Cost Per Acquisition', data: cpa, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top', labels: { color: '#a1a1aa' } } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } },
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } }
                        }
                    }
                });
            }

            // Performance Distribution Chart
            const performanceCtx = document.getElementById('influencerPerformanceChart');
            if (performanceCtx) {
                const performanceScores = data.map(item => (parseFloat(item.engagement_rate) * 0.4 + (parseInt(item.conversions) / Math.max(1, parseInt(item.reach)) * 100) * 0.6));
                
                new Chart(performanceCtx, {
                    type: 'doughnut',
                    data: {
                        labels,
                        datasets: [{
                            data: performanceScores,
                            backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
                    }
                });
            }
        }

        function displayCampaignPerformance(analysis) {
            const contentDiv = document.getElementById('analysisContent');
            if (!contentDiv) return;
            const res = analysis?.outputs?.res || [];
            if (!Array.isArray(res) || res.length === 0) {
                contentDiv.innerHTML = '<p class="text-center">No campaign performance data available.</p>';
                return;
            }

            const totals = res.reduce((acc, item) => {
                acc.impressions += Number(item.impressions) || 0;
                acc.reach += Number(item.reach) || 0;
                acc.engagements += Number(item.engagements) || 0;
                acc.clicks += Number(item.clicks) || 0;
                acc.conversions += Number(item.conversions) || 0;
                acc.spend += Number(item.spend) || 0;
                return acc;
            }, { impressions:0, reach:0, engagements:0, clicks:0, conversions:0, spend:0 });

            const avgCpc = totals.clicks ? totals.spend / totals.clicks : 0;
            const avgCpa = totals.conversions ? totals.spend / totals.conversions : 0;
            const avgRoi = totals.spend ? ((totals.conversions * 25) / totals.spend) : 0;
            const ctr = totals.impressions ? (totals.clicks / totals.impressions) * 100 : 0;

            contentDiv.innerHTML = `
                <div class="performance-overview">
                    <h3>Campaign Performance Overview</h3>
                    <div class="metrics-grid compact metric-group">
                        ${metricCard('Total Impressions', formatNumber(totals.impressions), 'fa-eye', true)}
                        ${metricCard('Total Reach', formatNumber(totals.reach), 'fa-users', true)}
                        ${metricCard('Total Engagements', formatNumber(totals.engagements), 'fa-heart', true)}
                        ${metricCard('Total Clicks', formatNumber(totals.clicks), 'fa-mouse-pointer', true)}
                        ${metricCard('Total Conversions', formatNumber(totals.conversions), 'fa-chart-line', true)}
                        ${metricCard('Total Spend', `$${totals.spend.toFixed(2)}`, 'fa-dollar-sign', true)}
                    </div>
                </div>
                <div class="performance-metrics">
                    <h3>Key Metrics</h3>
                    <div class="metrics-grid compact metric-group">
                        ${metricCard('Average CPC', `$${avgCpc.toFixed(2)}`, 'fa-circle-dot', true)}
                        ${metricCard('Average CPA', `$${avgCpa.toFixed(2)}`, 'fa-user-check', true)}
                        ${metricCard('ROI', `${avgRoi.toFixed(2)}x`, 'fa-arrow-trend-up', true)}
                        ${metricCard('CTR', `${ctr.toFixed(2)}%`, 'fa-percentage', true)}
                    </div>
                </div>
                <div class="performance-charts">
                    <h3>Performance Trends</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>Engagements Over Time</h4>
                            <canvas id="engagementsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Reach vs Impressions</h4>
                            <canvas id="reachImpressionsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Cost Metrics</h4>
                            <canvas id="costMetricsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Conversion Rate</h4>
                            <canvas id="conversionRateChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="performance-table">
                    <h3>Detailed Performance Data</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Impressions</th>
                                    <th>Reach</th>
                                    <th>Engagements</th>
                                    <th>Clicks</th>
                                    <th>Conversions</th>
                                    <th>Spend</th>
                                    <th>CPC</th>
                                    <th>CPA</th>
                                    <th>ROI</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${res.map(item => `
                                    <tr>
                                        <td>${new Date(item.report_date).toLocaleDateString()}</td>
                                        <td>${formatNumber(Number(item.impressions)||0)}</td>
                                        <td>${formatNumber(Number(item.reach)||0)}</td>
                                        <td>${formatNumber(Number(item.engagements)||0)}</td>
                                        <td>${formatNumber(Number(item.clicks)||0)}</td>
                                        <td>${formatNumber(Number(item.conversions)||0)}</td>
                                        <td>$${Number(item.spend||0).toFixed(2)}</td>
                                        <td>$${Number(item.cpc||0).toFixed(2)}</td>
                                        <td>$${Number(item.cpa||0).toFixed(2)}</td>
                                        <td>${Number(item.roi||0).toFixed(2)}x</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            setTimeout(() => createCampaignPerformanceCharts(res), 100);
        }

        function createCampaignPerformanceCharts(data) {
            const dates = data.map(d => new Date(d.report_date).toLocaleDateString());
            const engagements = data.map(d => Number(d.engagements)||0);
            const reach = data.map(d => Number(d.reach)||0);
            const impressions = data.map(d => Number(d.impressions)||0);
            const clicks = data.map(d => Number(d.clicks)||0);
            const conversions = data.map(d => Number(d.conversions)||0);
            const cpc = data.map(d => Number(d.cpc)||0);
            const cpa = data.map(d => Number(d.cpa)||0);

            const engagementsCtx = document.getElementById('engagementsChart');
            if (engagementsCtx) {
                new Chart(engagementsCtx, { type:'line', data:{ labels: dates, datasets:[{ label:'Engagements', data: engagements, borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,0.1)', tension:0.4 }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ color:'#a1a1aa' }, grid:{ color:'rgba(255,255,255,0.1)'} }, x:{ ticks:{ color:'#a1a1aa' }, grid:{ color:'rgba(255,255,255,0.1)'} } } } });
            }

            const reachImpCtx = document.getElementById('reachImpressionsChart');
            if (reachImpCtx) {
                new Chart(reachImpCtx, { type:'bar', data:{ labels: dates, datasets:[ { label:'Reach', data: reach, backgroundColor:'#10b981', borderColor:'#059669', borderWidth:1 }, { label:'Impressions', data: impressions, backgroundColor:'#3b82f6', borderColor:'#2563eb', borderWidth:1 } ] }, options:{ responsive:true, plugins:{ legend:{ position:'top', labels:{ color:'#a1a1aa'} } }, scales:{ y:{ beginAtZero:true, ticks:{ color:'#a1a1aa' }, grid:{ color:'rgba(255,255,255,0.1)'} }, x:{ ticks:{ color:'#a1a1aa' }, grid:{ color:'rgba(255,255,255,0.1)'} } } } });
            }

            const costCtx = document.getElementById('costMetricsChart');
            if (costCtx) {
                new Chart(costCtx, { type:'line', data:{ labels: dates, datasets:[ { label:'CPC', data: cpc, borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.1)', tension:0.4 }, { label:'CPA', data: cpa, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.1)', tension:0.4 } ] }, options:{ responsive:true, plugins:{ legend:{ position:'top', labels:{ color:'#a1a1aa'} } }, scales:{ y:{ beginAtZero:true, ticks:{ color:'#a1a1aa' }, grid:{ color:'rgba(255,255,255,0.1)'} }, x:{ ticks:{ color:'#a1a1aa' }, grid:{ color:'rgba(255,255,255,0.1)'} } } } });
            }

            const convCtx = document.getElementById('conversionRateChart');
            if (convCtx) {
                const convRate = data.map(d => {
                    const clicks = Number(d.clicks)||0; const conv = Number(d.conversions)||0; return clicks ? (conv/clicks*100).toFixed(2) : 0; });
                new Chart(convCtx, { type:'doughnut', data:{ labels: dates, datasets:[{ data: convRate, backgroundColor:['#10b981','#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#84cc16','#f97316','#ec4899','#6366f1'] }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color:'#a1a1aa'} } } } });
            }
        }

        function displayAudienceInsights(analysis) {
            const contentDiv = document.getElementById('analysisContent');
            const res = analysis.outputs?.res || [];
            
            if (!res || res.length === 0) {
                contentDiv.innerHTML = '<p class="text-center">No audience insights data available.</p>';
                return;
            }

            const audienceData = res[0]; // Assuming single audience data object

            contentDiv.innerHTML = `
                <!-- Audience Overview -->
                <div class="audience-overview">
                    <h3>Audience Demographics & Behavior</h3>
                    <div class="overview-grid">
                        <div class="overview-card">
                            <div class="overview-icon">
                                <i class="fas fa-venus-mars"></i>
                            </div>
                            <div class="overview-content">
                                <div class="overview-value">${audienceData.gender_distribution}</div>
                                <div class="overview-label">Gender Distribution</div>
                            </div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="overview-content">
                                <div class="overview-value">${audienceData.avg_income_level}</div>
                                <div class="overview-label">Average Income Level</div>
                            </div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="overview-content">
                                <div class="overview-value">${audienceData.device_usage}</div>
                                <div class="overview-label">Device Usage</div>
                            </div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="overview-content">
                                <div class="overview-value">${audienceData.location_top_countries}</div>
                                <div class="overview-label">Top Countries</div>
                            </div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-icon">
                                <i class="fas fa-birthday-cake"></i>
                            </div>
                            <div class="overview-content">
                                <div class="overview-value">${audienceData.age_group}</div>
                                <div class="overview-label">Age Group</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audience Insights Charts -->
                <div class="audience-charts">
                    <h3>Audience Analysis</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>Gender Distribution</h4>
                            <canvas id="genderChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Device Usage</h4>
                            <canvas id="deviceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Geographic Distribution</h4>
                            <canvas id="locationChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Income Level Analysis</h4>
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Audience Insights -->
                <div class="audience-insights">
                    <h3>Key Audience Insights</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-header">
                                <i class="fas fa-venus-mars"></i>
                                <h4>Gender Targeting</h4>
                            </div>
                            <div class="insight-content">
                                <p>Your audience is predominantly <strong>${audienceData.gender_distribution.split('/')[0].trim()}</strong>. 
                                Consider tailoring content and messaging to better resonate with this demographic.</p>
                            </div>
                        </div>
                        
                        <div class="insight-card">
                            <div class="insight-header">
                                <i class="fas fa-mobile-alt"></i>
                                <h4>Mobile-First Strategy</h4>
                            </div>
                            <div class="insight-content">
                                <p>With <strong>${audienceData.device_usage.split(',')[0]}</strong> of your audience on mobile, 
                                ensure all content is optimized for mobile viewing and interaction.</p>
                            </div>
                        </div>
                        
                        <div class="insight-card">
                            <div class="insight-header">
                                <i class="fas fa-globe"></i>
                                <h4>Geographic Focus</h4>
                            </div>
                            <div class="insight-content">
                                <p>Your top markets are <strong>${audienceData.location_top_countries}</strong>. 
                                Consider localizing content and timing posts for these regions.</p>
                            </div>
                        </div>
                        
                        <div class="insight-card">
                            <div class="insight-header">
                                <i class="fas fa-dollar-sign"></i>
                                <h4>Income-Based Targeting</h4>
                            </div>
                            <div class="insight-content">
                                <p>Your audience has an average income of <strong>${audienceData.avg_income_level}</strong>. 
                                Adjust pricing strategies and product recommendations accordingly.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="audience-recommendations">
                    <h3>Strategic Recommendations</h3>
                    <div class="recommendations-list">
                        <div class="recommendation-item">
                            <div class="recommendation-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="recommendation-content">
                                <h4>Content Strategy</h4>
                                <p>Focus on creating mobile-optimized content that appeals to ${audienceData.age_group} age group, 
                                with messaging that resonates with ${audienceData.gender_distribution.split('/')[0].trim()} audience.</p>
                            </div>
                        </div>
                        
                        <div class="recommendation-item">
                            <div class="recommendation-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="recommendation-content">
                                <h4>Timing Optimization</h4>
                                <p>Schedule posts during peak hours for ${audienceData.location_top_countries.split(',')[0]} timezone 
                                to maximize engagement with your primary audience.</p>
                            </div>
                        </div>
                        
                        <div class="recommendation-item">
                            <div class="recommendation-icon">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="recommendation-content">
                                <h4>Pricing Strategy</h4>
                                <p>With an average income of ${audienceData.avg_income_level}, consider offering 
                                flexible payment options and value-focused product bundles.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Create charts after DOM is updated
            setTimeout(() => {
                createAudienceInsightsCharts(audienceData);
            }, 100);
        }

        function createAudienceInsightsCharts(audienceData) {
            // Gender Distribution Chart
            const genderCtx = document.getElementById('genderChart');
            if (genderCtx) {
                const genderParts = audienceData.gender_distribution.split('/');
                const femalePercent = parseInt(genderParts[0]);
                const malePercent = parseInt(genderParts[1]);
                
                new Chart(genderCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Female', 'Male'],
                        datasets: [{
                            data: [femalePercent, malePercent],
                            backgroundColor: ['#ec4899', '#3b82f6'],
                            borderWidth: 2,
                            borderColor: '#1f2937'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#a1a1aa' }
                            }
                        }
                    }
                });
            }

            // Device Usage Chart
            const deviceCtx = document.getElementById('deviceChart');
            if (deviceCtx) {
                const deviceParts = audienceData.device_usage.split(',');
                const mobilePercent = parseInt(deviceParts[0]);
                const desktopPercent = parseInt(deviceParts[1]);
                
                new Chart(deviceCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Mobile', 'Desktop'],
                        datasets: [{
                            data: [mobilePercent, desktopPercent],
                            backgroundColor: ['#10b981', '#8b5cf6'],
                            borderWidth: 2,
                            borderColor: '#1f2937'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#a1a1aa' }
                            }
                        }
                    }
                });
            }

            // Geographic Distribution Chart
            const locationCtx = document.getElementById('locationChart');
            if (locationCtx) {
                const countries = audienceData.location_top_countries.split(',');
                const countryData = countries.map((country, index) => ({
                    country: country.trim(),
                    percentage: 100 - (index * 20) // Simple distribution
                }));
                
                new Chart(locationCtx, {
                    type: 'bar',
                    data: {
                        labels: countryData.map(item => item.country),
                        datasets: [{
                            label: 'Audience Distribution (%)',
                            data: countryData.map(item => item.percentage),
                            backgroundColor: '#f59e0b',
                            borderColor: '#d97706',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#a1a1aa' }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#a1a1aa' }
                            }
                        }
                    }
                });
            }

            // Income Level Chart
            const incomeCtx = document.getElementById('incomeChart');
            if (incomeCtx) {
                const incomeRange = audienceData.avg_income_level;
                
                new Chart(incomeCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Income Level'],
                        datasets: [{
                            label: 'Average Income',
                            data: [1], // Placeholder for visualization
                            backgroundColor: '#06b6d4',
                            borderColor: '#0891b2',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Income Level: ${incomeRange}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { 
                                    color: '#a1a1aa',
                                    callback: function() {
                                        return incomeRange;
                                    }
                                }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#a1a1aa' }
                            }
                        }
                    }
                });
            }
        }

        async function loadCampaignsForAnalysis() {
            try {
                const response = await fetch('/api/list_campaigns');
                const data = await response.json();
                if (!data.success || !data.campaigns) {
                    console.warn('No campaigns returned:', data);
                    return;
                }
                const select = document.getElementById('campaignName');
                if (!select) return;
                select.innerHTML = '<option value="">Select a campaign...</option>';
                // Reset mapping
                campaignIdMap = {};
                (data.campaigns || []).forEach((c) => {
                    const isObj = c && typeof c === 'object';
                    const id = isObj ? (c.campaign_id || c.id || c.campaignId || c.ID) : String(c);
                    const name = isObj ? (c.campaign_name || c.name || c.title || id) : String(c);
                    if (!id) return;
                    campaignIdMap[String(name)] = String(id);
                    const opt = document.createElement('option');
                    opt.value = String(name);
                    opt.textContent = String(name);
                    select.appendChild(opt);
                });
                console.log('Campaigns loaded. Mapping:', campaignIdMap);
            } catch (err) {
                console.error('Failed to load campaigns:', err);
            }
        }

        // Email Modal Functions
        const emailModal = document.getElementById('emailModal');
        const emailToInput = document.getElementById('email_to');
        const emailSubjectInput = document.getElementById('email_subject');
        const emailBodyInput = document.getElementById('email_body');
        const emailPreviewDiv = document.getElementById('email_preview');
        const emailSendBtn = document.getElementById('emailSendBtn');
        const emailLoadingSpan = emailSendBtn.querySelector('.email-loading');

        function openEmailModal(name, username) {
            emailToInput.value = `${name.replace(/_/g, ' ')} <${username}@example.com>`; // Example email format
            emailSubjectInput.value = `Re: Campaign Performance with ${name}`;
            emailBodyInput.value = `Hi ${name},\n\nHere's a summary of your campaign performance:\n\n`;
            emailPreviewDiv.innerHTML = ''; // Clear previous preview
            emailModal.style.display = 'block';
        }

        function closeEmailModal() {
            emailModal.style.display = 'none';
            emailToInput.value = '';
            emailSubjectInput.value = '';
            emailBodyInput.value = '';
            emailPreviewDiv.innerHTML = '';
            emailSendBtn.disabled = false;
            emailLoadingSpan.style.display = 'none';
        }

        async function generateEmailPreview() {
            const to = emailToInput.value;
            const subject = emailSubjectInput.value;
            const body = emailBodyInput.value;

            if (!to || !subject || !body) {
                showError('Please fill in all email fields.');
                return;
            }

            emailSendBtn.disabled = true;
            emailLoadingSpan.style.display = 'inline-block';
            emailPreviewDiv.innerHTML = '<p>Generating email preview...</p>';

            try {
                const response = await fetch('/api/generate_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, body })
                });
                const data = await response.json();
                if (data.success) {
                    emailPreviewDiv.innerHTML = data.preview;
                } else {
                    emailPreviewDiv.innerHTML = `<p style="color: red;">Error generating email preview: ${data.message || 'Unknown error'}</p>`;
                }
            } catch (e) {
                console.error('Error generating email preview:', e);
                emailPreviewDiv.innerHTML = `<p style="color: red;">Error generating email preview: ${e.message || 'Unknown error'}</p>`;
            } finally {
                emailLoadingSpan.style.display = 'none';
            }
        }

        async function sendEmail() {
            const to = emailToInput.value;
            const subject = emailSubjectInput.value;
            const body = emailBodyInput.value;

            if (!to || !subject || !body) {
                showError('Please fill in all email fields.');
                return;
            }

            emailSendBtn.disabled = true;
            emailLoadingSpan.style.display = 'inline-block';
            emailPreviewDiv.innerHTML = '<p>Sending email...</p>';

            try {
                const response = await fetch('/api/send_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, body })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Email sent successfully!', 'success');
                    closeEmailModal();
                } else {
                    emailPreviewDiv.innerHTML = `<p style="color: red;">Error sending email: ${data.message || 'Unknown error'}</p>`;
                }
            } catch (e) {
                console.error('Error sending email:', e);
                emailPreviewDiv.innerHTML = `<p style="color: red;">Error sending email: ${e.message || 'Unknown error'}</p>`;
            } finally {
                emailLoadingSpan.style.display = 'none';
            }
        }

        // Close modal if user clicks outside
        window.onclick = function(event) {
            if (event.target == emailModal) {
                closeEmailModal();
            }
        }

        // Email Modal Logic
        let currentEmailContext = { campaignId: null, influencerName: '', influencerUsername: '' };

        window.openEmailModal = async function(name, username) {
            currentEmailContext = { campaignId: lastAnalysisContext.campaignId, influencerName: name, influencerUsername: username };
            const modal = document.getElementById('emailModal');
            if (!modal) return;
            modal.classList.add('active');
            // Prefill via generator
            try {
                showLoading('Generating email draft...');
                const resp = await fetch('/api/generate_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_id: currentEmailContext.campaignId,
                        influencer_name: currentEmailContext.influencerName,
                        influencer_username: currentEmailContext.influencerUsername
                    })
                });
                const data = await resp.json();
                if (data.success && data.email) {
                    document.getElementById('email_to').value = data.email.email || '';
                    document.getElementById('email_subject').value = data.email.subject || '';
                    document.getElementById('email_body').value = data.email.body || '';
                    document.getElementById('email_preview').textContent = data.email.body || '';
                } else {
                    showError(data.message || 'Failed to generate email');
                }
            } catch (e) {
                console.error('Email generation error:', e);
                showError('Failed to generate email');
            } finally {
                hideLoading();
            }
        }

        window.closeEmailModal = function() {
            const modal = document.getElementById('emailModal');
            if (!modal) return;
            modal.classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const sendBtn = document.getElementById('emailSendBtn');
            if (sendBtn) {
                sendBtn.addEventListener('click', async function() {
                    try {
                        const mail_to = document.getElementById('email_to').value.trim();
                        const subject = document.getElementById('email_subject').value.trim();
                        const body = document.getElementById('email_body').value.trim();
                        if (!mail_to || !subject || !body) {
                            showError('Please fill all email fields');
                            return;
                        }
                        this.disabled = true;
                        this.querySelector('.email-loading').style.display = 'inline-block';
                        const resp = await fetch('/api/send_email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ mail_to, subject, body })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            showNotification('Email sent successfully', 'success');
                            closeEmailModal();
                        } else {
                            showError(data.message || 'Failed to send email');
                        }
                    } catch (e) {
                        console.error('Send email error:', e);
                        showError('Failed to send email');
                    } finally {
                        this.disabled = false;
                        this.querySelector('.email-loading').style.display = 'none';
                    }
                });
            }
            const bodyInput = document.getElementById('email_body');
            if (bodyInput) {
                bodyInput.addEventListener('input', function() {
                    document.getElementById('email_preview').textContent = this.value;
                });
            }
        });
    </script>
</body>
</html>
